<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Russell E. Lewis">
<meta name="author" content="Dimitrios P. Kontoyiannis">
<meta name="keywords" content="Liposomal amphotericin B, invasive mucormycosis, pharmacokinetics/pharmacodynamics">

<title>Does evidence support high-dose liposomal amphotericin B in the treatment of mucormycosis?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="HD_Ambi_files/libs/clipboard/clipboard.min.js"></script>
<script src="HD_Ambi_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="HD_Ambi_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="HD_Ambi_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="HD_Ambi_files/libs/quarto-html/popper.min.js"></script>
<script src="HD_Ambi_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="HD_Ambi_files/libs/quarto-html/anchor.min.js"></script>
<link href="HD_Ambi_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="HD_Ambi_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="HD_Ambi_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="HD_Ambi_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="HD_Ambi_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Does evidence support high-dose liposomal amphotericin B in the treatment of mucormycosis?</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Russell E. Lewis <a href="mailto:russelledward.lewis@unipd.it" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Padua
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Dimitrios P. Kontoyiannis <a href="mailto:dkontoyi@mdanderson.org" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            The University of Texas M.D.&nbsp;Anderson Cancer Center
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>Introduction, Areas covered:, Expert opionion:</p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Liposomal amphotericin B, invasive mucormycosis, pharmacokinetics/pharmacodynamics</p>
  </div>
</div>

</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Invasive mucormycosis, caused primarily by <em>Rhizopus</em>, <em>Mucor</em>, and <em>Lichtheimia</em> species of the order Mucorales, is a life-threatening infection that has increased in incidence over the past two decades, predominantly affecting immunocompromised patients with hematologic malignancies, solid organ or hematopoietic cell transplantation, and poorly controlled diabetes mellitus <span class="citation" data-cites="skiada2025">[<a href="#ref-skiada2025" role="doc-biblioref">1</a>]</span>. Characterized by aggressive angioinvasion and tissue necrosis, mucormycosis carries mortality rates of 40-80% depending on infection site, diagnostic and treatment delays, feasibility of surgical debridement, and host immune recovery <span class="citation" data-cites="sigera2023a jeong2019">[<a href="#ref-sigera2023a" role="doc-biblioref">2</a>,<a href="#ref-jeong2019" role="doc-biblioref">3</a>]</span>. Current guidelines recommend initial therapy with intravenous liposomal amphotericin B (L-AMB) until clinical stabilization, followed by step-down to posaconazole or isavuconazole <span class="citation" data-cites="cornely2019">[<a href="#ref-cornely2019" role="doc-biblioref">4</a>]</span>.</p>
<p>Due to the aggressiveness of the infection and the reduced <em>in vitro</em> susceptibility of Mucorales compared with <em>Aspergillus</em> species, higher L-AMB doses (&gt;5 mg/kg/day) are frequently administered during acute infection to achieve rapid tissue drug concentrations and limit fungal dissemination <span class="citation" data-cites="lewis2012">[<a href="#ref-lewis2012" role="doc-biblioref">5</a>]</span>. Although some animal models support this high-dose strategy <span class="citation" data-cites="lewis2010">[<a href="#ref-lewis2010" role="doc-biblioref">6</a>]</span>, prospective trials <span class="citation" data-cites="lanternier2015 spellberg2011">[<a href="#ref-lanternier2015" role="doc-biblioref">7</a>,<a href="#ref-spellberg2011" role="doc-biblioref">8</a>]</span> and many observational studies <span class="citation" data-cites="tashiro2023 jestin2021 risum2020 valiante2023">[<a href="#ref-tashiro2023" role="doc-biblioref">9</a>â€“<a href="#ref-valiante2023" role="doc-biblioref">12</a>]</span> have failed to provide evidence of a clear dose-response relationship with L-AMB dosing and mortality in invasive mucormycosis. Indeed, the Global guidelines for the diagnosis and management of mucormycosis produced by the European Confederation of Medical Mycology (ECMM)/Mycoses Study Group Education and Research Consortium (MSGERC) recommend a broad initial dosing range of 5-10 mg/kg/day <span class="citation" data-cites="cornely2019">[<a href="#ref-cornely2019" role="doc-biblioref">4</a>]</span>.</p>
<p>This uncertainty regarding the optimal dosing of L-AMB is clinically important as higher doses could carry increased risks of nephrotoxicity and infusion-related reactions without definitive evidence of improved survival <span class="citation" data-cites="jeong2019">[<a href="#ref-jeong2019" role="doc-biblioref">3</a>]</span>. In this review, we critically evaluate the pharmacokinetic, preclinical, and clinical evidence supporting dose escalation, examine patient-specific factors that may influence the benefit-risk ratio of higher doses, and provide practical recommendations for individualizing L-AMB dosing in invasive mucormycosis.</p>
<section id="pharmacodynamics-and-toxicodynamics-of-liposomal-amphotericin-b" class="level2">
<h2 class="anchored" data-anchor-id="pharmacodynamics-and-toxicodynamics-of-liposomal-amphotericin-b">Pharmacodynamics and toxicodynamics of liposomal amphotericin B</h2>
<p>Amphotericin B (AMB) is a polyene macrolide antifungal agent with broad-spectrum activity against most clinically relevant fungi. Its amphiphillic structure renders it insoluable in body fluids and and neutral pH. The primary mechanism of action of amphotericin B has long thought to involve binding to ergosterol in fungal cell membranes, forming transmembrane channels that disrupt membrane integrity and cause lethal ion leakage, particularly of potassium. However, more recent studies using solid-state NMR suggest amphotericin B forms extramembraneous aggregates or sponges that extract ergosterol from the fungal cell wall <span class="citation" data-cites="anderson2014 lewandowska2021">[<a href="#ref-anderson2014" role="doc-biblioref">13</a>,<a href="#ref-lewandowska2021" role="doc-biblioref">14</a>]</span>.</p>
<p>Amphotericin B exhibits concentration-dependent killing and prolonged post-antifungal effects in yeast and molds, supporting infrequent dosing regimens <span class="citation" data-cites="andes2001 wiederhold2006">[<a href="#ref-andes2001" role="doc-biblioref">15</a>,<a href="#ref-wiederhold2006" role="doc-biblioref">16</a>]</span>. The liposomal formulation of amphotericin B encapsulates the antifungal in unilamellar vesicles, reducing drug interaction with mammalian cell membranes while enhancing tissue distribution and reducing toxicity compared with conventional amphotericin B deoxycholate <span class="citation" data-cites="groll2019">[<a href="#ref-groll2019" role="doc-biblioref">17</a>]</span>.</p>
<p>Relatively few studies have explored the pharmacodynamics of escalating L-AMB doses</p>
</section>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" role="list">
<div id="ref-skiada2025" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">Skiada A, Drogari-Apiranthitou M, Roilides E, et al. <a href="https://doi.org/10.1007/s11046-025-00954-6">A Global Analysis of Cases of Mucormycosis Recorded in the European Confederation of Medical Mycology / International Society for Human and Animal Mycology (ECMM / ISHAM) Zygomyco.net Registry from 2009 to 2022</a>. Mycopathologia [Internet]. 2025;190(4):53.</div>
</div>
<div id="ref-sigera2023a" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">Sigera LSM, Denning DW. <a href="https://doi.org/10.1093/ofid/ofad704">A Systematic Review of the Therapeutic Outcome of Mucormycosis</a>. Open Forum Infectious Diseases [Internet]. 2023;11(1).</div>
</div>
<div id="ref-jeong2019" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">Jeong W, Keighley C, Wolfe R, et al. <a href="https://doi.org/10.1016/j.ijantimicag.2019.01.002">Contemporary management and clinical outcomes of mucormycosis: A systematic review and meta-analysis of case reports</a>. International Journal of Antimicrobial Agents [Internet]. 2019;53(5):589â€“597.</div>
</div>
<div id="ref-cornely2019" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">Cornely OA, Alastruey-Izquierdo A, Arenz D, et al. <a href="https://doi.org/10.1016/S1473-3099(19)30312-3">Global guideline for the diagnosis and management of mucormycosis: An initiative of the european confederation of medical mycology in cooperation with the mycoses study group education and research consortium</a>. The Lancet Infectious Diseases [Internet]. 2019;19(12):e405 e421.</div>
</div>
<div id="ref-lewis2012" class="csl-entry" role="listitem">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">Lewis RE, Lortholary O, Spellberg B, et al. <a href="https://doi.org/10.1093/cid/cir884">How does antifungal pharmacology differ for mucormycosis versus aspergillosis?</a> Clinical Infectious Diseases [Internet]. 2012;54(SUPPL. 1):S67S72.</div>
</div>
<div id="ref-lewis2010" class="csl-entry" role="listitem">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">Lewis RE, Albert ND, Liao G, et al. <a href="https://doi.org/10.1128/AAC.01222-09">Comparative pharmacodynamics of amphotericin b lipid complex and liposomal amphotericin b in a murine model of pulmonary mucormycosis</a>. Antimicrobial Agents and Chemotherapy [Internet]. 2010;54(3):1298â€“1304.</div>
</div>
<div id="ref-lanternier2015" class="csl-entry" role="listitem">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline">Lanternier F, Poiree S, Elie C, et al. <a href="https://doi.org/10.1093/jac/dkv236">Prospective pilot study of high-dose (10 mg/kg/day) liposomal amphotericin B (L-AMB) for the initial treatment of mucormycosis</a>. Journal of Antimicrobial Chemotherapy [Internet]. 2015;70(11):3116â€“3123.</div>
</div>
<div id="ref-spellberg2011" class="csl-entry" role="listitem">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline">Spellberg B, Ibrahim AS, Chin-Hong PV, et al. <a href="https://doi.org/10.1093/jac/dkr375">The Deferasirox<span></span>AmBisome Therapy for Mucormycosis (DEFEAT Mucor) study: a randomized, double-blinded, placebo-controlled trial</a>. Journal of Antimicrobial Chemotherapy [Internet]. 2011;67(3):715â€“722.</div>
</div>
<div id="ref-tashiro2023" class="csl-entry" role="listitem">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline">Tashiro M, Namie H, Ito Y, et al. <a href="https://doi.org/10.1093/ofid/ofad480">Prognostic Association of Liposomal Amphotericin B Doses Above 5<span></span>mg/kg/d in Mucormycosis: A Nationwide Epidemiologic and Treatment Analysis in Japan</a>. Open Forum Infectious Diseases [Internet]. 2023;10(10).</div>
</div>
<div id="ref-jestin2021" class="csl-entry" role="listitem">
<div class="csl-left-margin">[10] </div><div class="csl-right-inline">Jestin M, Azoulay E, PÃ¨ne F, et al. <a href="https://doi.org/10.1186/s13613-021-00818-4">Poor outcome associated with mucormycosis in critically ill hematological patients: results of a multicenter study</a>. Annals of Intensive Care [Internet]. 2021;11(1).</div>
</div>
<div id="ref-risum2020" class="csl-entry" role="listitem">
<div class="csl-left-margin">[11] </div><div class="csl-right-inline">Risum M, Helweg-Larsen J, Petersen SL, et al. <a href="https://doi.org/10.3390/jof6040268">Introduction of a Comprehensive Diagnostic and Interdisciplinary Management Approach in Haematological Patients with Mucormycosis: A Pre and Post-Intervention Analysis</a>. Journal of Fungi [Internet]. 2020;6(4):268.</div>
</div>
<div id="ref-valiante2023" class="csl-entry" role="listitem">
<div class="csl-left-margin">[12] </div><div class="csl-right-inline">Valiante S, Elshaboury RH, Wu T, et al. <a href="https://doi.org/10.1093/ofid/ofad500.890">845. Clinical Outcomes in Patients Treated with High vs. Standard Dose Liposomal Amphotericin B for Invasive Mucormycosis</a>. Open Forum Infectious Diseases [Internet]. 2023;10(Supplement<span>_</span>2).</div>
</div>
<div id="ref-anderson2014" class="csl-entry" role="listitem">
<div class="csl-left-margin">[13] </div><div class="csl-right-inline">Anderson TM, Clay MC, Cioffi AG, et al. <a href="https://doi.org/10.1038/nchembio.1496">Amphotericin forms an extramembranous and fungicidal sterol sponge</a>. Nature Chemical Biology. 2014;10(5):400â€“406.</div>
</div>
<div id="ref-lewandowska2021" class="csl-entry" role="listitem">
<div class="csl-left-margin">[14] </div><div class="csl-right-inline">Lewandowska A, Soutar CP, Greenwood AI, et al. <a href="https://doi.org/10.1038/s41594-021-00685-4">Fungicidal amphotericin B sponges are assemblies of staggered asymmetric homodimers encasing large void volumes</a>. Nature Structural &amp; Molecular Biology. 2021;28(12):972â€“981.</div>
</div>
<div id="ref-andes2001" class="csl-entry" role="listitem">
<div class="csl-left-margin">[15] </div><div class="csl-right-inline">Andes D, Stamsted T, Conklin R. <a href="https://doi.org/10.1128/AAC.45.3.922-926.2001">Pharmacodynamics of amphotericin B in a neutropenic-mouse disseminated-candidiasis model</a>. Antimicrobial agents and chemotherapy [Internet]. 2001;45(3):922926.</div>
</div>
<div id="ref-wiederhold2006" class="csl-entry" role="listitem">
<div class="csl-left-margin">[16] </div><div class="csl-right-inline">Wiederhold NP, Tam VH, Chi J, et al. <a href="https://doi.org/10.1128/AAC.50.2.469-473.2006">Pharmacodynamic activity of amphotericin b deoxycholate is associated with peak plasma concentrations in a neutropenic murine model of invasive pulmonary aspergillosis</a>. Antimicrobial Agents and Chemotherapy. 2006;50(2):469473.</div>
</div>
<div id="ref-groll2019" class="csl-entry" role="listitem">
<div class="csl-left-margin">[17] </div><div class="csl-right-inline">Groll AH, Rijnders BJA, Walsh TJ, et al. <a href="https://doi.org/10.1093/cid/ciz076">Clinical pharmacokinetics, pharmacodynamics, safety and efficacy of liposomal amphotericin b</a>. Clinical Infectious Diseases [Internet]. 2019;68(Supplement<span>_</span>4):S260â€“S274.</div>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>